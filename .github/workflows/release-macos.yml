name: Release macOS Binaries

on:
  pull_request:
    branches:
      - main
    types:
      - closed

permissions:
  contents: write

jobs:
  build-sign-notarize:
    if: github.event.pull_request.merged == true
    strategy:
      fail-fast: false
      matrix:
        include:
          - runner: macos-14
            arch: arm64
            artifact: silicon
          - runner: macos-13
            arch: x86_64
            artifact: intel

    runs-on: ${{ matrix.runner }}

    env:
      APP_NAME: 1132 Fixer
      CERT_P12_B64: ${{ secrets.APPLE_SIGNING_CERT_P12_BASE64 }}
      CERT_PASSWORD: ${{ secrets.APPLE_SIGNING_CERT_PASSWORD }}
      DEVELOPER_ID: ${{ secrets.APPLE_DEVELOPER_ID_APPLICATION }}
      APPLE_API_KEY_ID: ${{ secrets.APPLE_API_KEY_ID }}
      APPLE_API_ISSUER_ID: ${{ secrets.APPLE_API_ISSUER_ID }}
      APPLE_API_PRIVATE_KEY: ${{ secrets.APPLE_API_PRIVATE_KEY }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build release binary
        run: |
          set -euo pipefail
          swift build -c release --arch "${{ matrix.arch }}"

          BIN_DIR="$(swift build -c release --arch "${{ matrix.arch }}" --show-bin-path)"
          mkdir -p dist
          cp "$BIN_DIR/$APP_NAME" "dist/$APP_NAME"

      - name: Validate signing secrets
        run: |
          set -euo pipefail
          if [[ -z "$CERT_P12_B64" || -z "$CERT_PASSWORD" || -z "$DEVELOPER_ID" ]]; then
            echo "Missing signing secrets."
            exit 1
          fi

      - name: Import signing certificate
        uses: apple-actions/import-codesign-certs@v3
        with:
          p12-file-base64: ${{ env.CERT_P12_B64 }}
          p12-password: ${{ env.CERT_PASSWORD }}

      - name: Sign binary
        run: |
          set -euo pipefail
          codesign --force --timestamp --options runtime --sign "$DEVELOPER_ID" "dist/$APP_NAME"
          codesign --verify --strict --verbose=2 "dist/$APP_NAME"

      - name: Create DMG artifact
        run: |
          set -euo pipefail
          mkdir -p release
          DMG_NAME="1132-fixer-${{ matrix.artifact }}.dmg"
          PAYLOAD_DIR="$RUNNER_TEMP/dmg-payload-${{ matrix.artifact }}"
          mkdir -p "$PAYLOAD_DIR"
          cp "dist/$APP_NAME" "$PAYLOAD_DIR/$APP_NAME"
          hdiutil create \
            -volname "$APP_NAME" \
            -srcfolder "$PAYLOAD_DIR" \
            -ov \
            -format UDZO \
            "release/$DMG_NAME"

      - name: Notarize and staple DMG
        run: |
          set -euo pipefail
          if [[ -z "$APPLE_API_KEY_ID" || -z "$APPLE_API_ISSUER_ID" || -z "$APPLE_API_PRIVATE_KEY" ]]; then
            echo "Missing notarization secrets."
            exit 1
          fi

          KEY_FILE="$RUNNER_TEMP/AuthKey_${APPLE_API_KEY_ID}.p8"
          printf '%s' "$APPLE_API_PRIVATE_KEY" > "$KEY_FILE"

          DMG_PATH="release/1132-fixer-${{ matrix.artifact }}.dmg"
          xcrun notarytool submit "$DMG_PATH" \
            --key "$KEY_FILE" \
            --key-id "$APPLE_API_KEY_ID" \
            --issuer "$APPLE_API_ISSUER_ID" \
            --wait
          xcrun stapler staple "$DMG_PATH"

      - name: Upload release asset artifact
        uses: actions/upload-artifact@v4
        with:
          name: release-${{ matrix.artifact }}
          path: release/1132-fixer-${{ matrix.artifact }}.dmg

  create-release:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    needs: build-sign-notarize

    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: release-assets

      - name: Flatten artifacts
        run: |
          set -euo pipefail
          mkdir -p release
          find release-assets -type f -name '*.dmg' -exec cp {} release/ \;

      - name: Create GitHub release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail
          VERSION="v$(date -u +'%Y.%m.%d').${GITHUB_RUN_NUMBER}"
          gh release create "$VERSION" release/*.dmg \
            --title "$VERSION" \
            --notes "Automated release from merged PR #${{ github.event.pull_request.number }}"
